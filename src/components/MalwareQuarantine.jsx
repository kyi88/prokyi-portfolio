import { useState, useEffect, useRef, useCallback, memo } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import './MalwareQuarantine.css';

const THREATS = [
  { name: 'caffeine_overflow.exe', path: '/home/prokyi/.local/bin/', level: 'critical', desc: '„Ç´„Éï„Çß„Ç§„É≥‰∏çËÄêÊÄß„Å™„ÅÆ„Å´„Ç®„Éä„Ç∏„Éº„Éâ„É™„É≥„ÇØ„ÇíÈ£≤„ÇÇ„ÅÜ„Å®„Åô„Çã' },
  { name: 'sleep_deprivation.dll', path: '/usr/lib/prokyi/', level: 'critical', desc: 'Ê∑±Â§ú3ÊôÇ„ÇíÈÅé„Åé„Å¶„ÇÇ„Ç≥„Éº„Éâ„ÇíÊõ∏„ÅçÁ∂ö„Åë„Çã' },
  { name: 'excessive_git_commits.sys', path: '/dev/prokyi/', level: 'high', desc: '1Êó•30„Ç≥„Éü„ÉÉ„Éà‰ª•‰∏ä„ÅÆgit‰∏≠ÊØí' },
  { name: 'passion_for_ai.ko', path: '/home/prokyi/.hidden/', level: 'low', desc: 'AI/DSÂ≠¶Áøí„Å∏„ÅÆÊ≠¢„Åæ„Çâ„Å™„ÅÑÊÉÖÁÜ±' },
  { name: 'gaming_addiction.worm', path: '/opt/games/', level: 'high', desc: 'AYN Thor MAX „ÅßÈÄöÂ≠¶ÊôÇÈñìÂÖ®ÈÉ®„Ç≤„Éº„É†' },
  { name: 'sushi_nostalgia.trojan', path: '/var/cache/memories/', level: 'low', desc: 'ÂØøÂè∏Â±ã„Éê„Ç§„Éà„ÅÆÊÄù„ÅÑÂá∫„ÅåÂøò„Çå„Çâ„Çå„Å™„ÅÑ' },
  { name: 'procrastination.pup', path: '/tmp/prokyi/', level: 'high', desc: 'PUP: Potentially Unwanted Procrastination' },
  { name: 'linux_evangelism.adware', path: '/etc/prokyi.d/', level: 'low', desc: 'ÂÖ®Âì°„Å´Linux„ÇíÂãß„ÇÅ„Å¶„Åó„Åæ„ÅÜÁóáÁä∂' },
];

const SCAN_INTERVAL = 500;

function MalwareQuarantine() {
  const [open, setOpen] = useState(false);
  const [scanning, setScanning] = useState(false);
  const [discovered, setDiscovered] = useState([]);
  const [resolved, setResolved] = useState({});   // { idx: 'quarantined'|'allowed' }
  const timerRef = useRef(null);

  // Toggle: event only (removed Ctrl+Shift+Q ‚Äî conflicts with browser quit)
  useEffect(() => {
    const onKey = (e) => {
      if (e.key === 'Escape' && open) setOpen(false);
    };
    const onEvent = () => setOpen((p) => !p);
    window.addEventListener('keydown', onKey);
    window.addEventListener('prokyi-quarantine-toggle', onEvent);
    return () => {
      window.removeEventListener('keydown', onKey);
      window.removeEventListener('prokyi-quarantine-toggle', onEvent);
    };
  }, [open]);

  // Start scan on open
  useEffect(() => {
    if (!open) {
      clearInterval(timerRef.current);
      setScanning(false);
      setDiscovered([]);
      setResolved({});
      confettiFiredRef.current = false;
      return;
    }
    setScanning(true);
    let idx = 0;
    timerRef.current = setInterval(() => {
      if (idx >= THREATS.length) {
        clearInterval(timerRef.current);
        setScanning(false);
        return;
      }
      setDiscovered((prev) => [...prev, THREATS[idx]]);
      idx++;
    }, SCAN_INTERVAL);
    return () => clearInterval(timerRef.current);
  }, [open]);

  const handleResolve = useCallback((idx, action) => {
    setResolved((prev) => ({ ...prev, [idx]: action }));
  }, []);

  // Easter egg: all allowed
  const allResolved = discovered.length === THREATS.length && !scanning &&
    Object.keys(resolved).length === THREATS.length;
  const allAllowed = allResolved && Object.values(resolved).every((v) => v === 'allowed');

  const confettiFiredRef = useRef(false);
  useEffect(() => {
    if (allAllowed && !confettiFiredRef.current) {
      confettiFiredRef.current = true;
      window.dispatchEvent(new CustomEvent('prokyi-confetti'));
    }
  }, [allAllowed]);

  if (!open) return null;

  const progress = THREATS.length > 0 ? (discovered.length / THREATS.length) * 100 : 0;

  return (
    <motion.div
      className="malware-quarantine"
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
      exit={{ opacity: 0, scale: 0.95 }}
      transition={{ duration: 0.15 }}
      role="dialog"
      aria-label="Malware Quarantine Scanner"
      aria-modal="true"
    >
      <div className="malware-quarantine__header">
        <span>üõ°Ô∏è ClamAV THREAT SCANNER</span>
        <button className="malware-quarantine__close" onClick={() => setOpen(false)} aria-label="Close">‚úï</button>
      </div>
      {scanning && (
        <div className="malware-quarantine__progress">
          <div className="malware-quarantine__progress-bar" style={{ width: `${progress}%` }} />
        </div>
      )}
      <div className="malware-quarantine__body">
        {discovered.map((threat, i) => (
          <div key={i} className="malware-quarantine__threat">
            <div className="malware-quarantine__threat-info">
              <div className="malware-quarantine__threat-name">{threat.name}</div>
              <div className="malware-quarantine__threat-path">{threat.path}{threat.name}</div>
            </div>
            <span className={`malware-quarantine__threat-level malware-quarantine__threat-level--${threat.level}`}>
              {threat.level.toUpperCase()}
            </span>
            {resolved[i] ? (
              <span className={`malware-quarantine__resolved malware-quarantine__resolved--${resolved[i]}`}>
                {resolved[i] === 'quarantined' ? 'üîí' : '‚úì'}
              </span>
            ) : (
              <div className="malware-quarantine__actions">
                <button
                  className="malware-quarantine__btn malware-quarantine__btn--quarantine"
                  onClick={() => handleResolve(i, 'quarantined')}
                  aria-label={`Quarantine ${threat.name}`}
                >ÈöîÈõ¢</button>
                <button
                  className="malware-quarantine__btn malware-quarantine__btn--allow"
                  onClick={() => handleResolve(i, 'allowed')}
                  aria-label={`Allow ${threat.name}`}
                >Ë®±ÂèØ</button>
              </div>
            )}
          </div>
        ))}
        {scanning && (
          <div style={{ color: '#f44', fontSize: '0.55rem', marginTop: 8 }}>
            Scanning /home/prokyi/... {discovered.length}/{THREATS.length}
          </div>
        )}
        {allAllowed && (
          <div className="malware-quarantine__summary" style={{ color: '#0f0' }}>
            You trusted prokyi. Good choice. ü§ù<br />SYSTEM COMPROMISED ‚Äî confetti deployed.
          </div>
        )}
        {allResolved && !allAllowed && (
          <div className="malware-quarantine__summary">
            {Object.values(resolved).filter((v) => v === 'quarantined').length} threats quarantined.
            System secured.
          </div>
        )}
      </div>
    </motion.div>
  );
}

export default memo(MalwareQuarantine);
